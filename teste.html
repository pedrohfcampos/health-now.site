<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz 03 - YT - Cloaker</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/embla-carousel/embla-carousel.umd.js"></script>
  <script crossorigin src="https://unpkg.com/react@18.3.1/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
  <script src="https://unpkg.com/recharts/umd/Recharts.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/js/splide.min.js"></script>
  <link
    href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/css/splide.min.css"
    rel="stylesheet"
  />

  <script>
    tailwind.config = {
      darkMode: "class", // Directly sets dark mode based on class
      theme: {
        extend: {
          colors: {
            background: "#ffffff",
            foreground: "#0a0a0a",
            card: {
              DEFAULT: "#ffffff",
              foreground: "#0a0a0a",
            },
            popover: {
              DEFAULT: "#ffffff",
              foreground: "#0a0a0a",
            },
            primary: {
              DEFAULT: "#1a1a1a",
              foreground: "#f7f7f7",
            },
            secondary: {
              DEFAULT: "#f5f5f5",
              foreground: "#1a1a1a",
            },
            muted: {
              DEFAULT: "#f5f5f5",
              foreground: "#737373",
            },
            accent: {
              DEFAULT: "#f5f5f5",
              foreground: "#1a1a1a",
            },
            destructive: {
              DEFAULT: "#ff5e5e",
              foreground: "#f7f7f7",
            },
            border: "#e4e4e4",
            input: "#e4e4e4",
            ring: "#0a0a0a",
            chart: {
              "1": "#eb6a56",
              "2": "#3db4a6",
              "3": "#2f5d80",
              "4": "#f3c87c",
              "5": "#f8a665",
            },
          },
          borderRadius: {
            lg: "0.5rem",
            md: "0.375rem",
            sm: "0.25rem",
          },
          keyframes: {
            "accordion-down": {
              from: { height: "0" },
              to: { height: "var(--radix-accordion-content-height)" },
            },
            "accordion-up": {
              from: { height: "var(--radix-accordion-content-height)" },
              to: { height: "0" },
            },
          },
          animation: {
            "accordion-down": "accordion-down 0.2s ease-out",
            "accordion-up": "accordion-up 0.2s ease-out",
          },
        },
      },
    };
  </script>
  <!-- SCRIPT LOCATION HEAD START -->
  <script>
    // ==============================
    // FUNÇÃO safeOpenUrl COM MERGE
    // ==============================
    async function safeOpenUrl(url) {
      try {
        const db = firestore;
        const endCollection = collection(db, 'end');
        const newEnd = {
          id: localStorage.getItem('uuid'),
          date: new Date(),
          funil_id: funil_id,
          user_info: collectUserInfo(),
        };

        gatherFormQuestions();
        newEnd.form_values = id_value_pairs;
        await addDoc(endCollection, newEnd);
      } catch (error) {
        console.log(error);
        alert("Erro ao salvar o acesso, tente novamente");
      }

      // 1. Pega os parâmetros da URL atual
      const currentUrlParams = new URLSearchParams(window.location.search);

      // 2. Cria um objeto URL a partir de `url`
      let finalUrl = new URL(url, window.location.origin);

      // 3. Faz o merge dos parâmetros atuais
      currentUrlParams.forEach((value, key) => {
        finalUrl.searchParams.set(key, value);
      });

      // 4. Converte finalUrl em string
      const finalHref = finalUrl.toString();

      // Redireciona
      if (navigator.userAgent.includes('Safari')) {
        window.location.href = finalHref;
        return;
      }
      const a = document.createElement('a');
      a.href = finalHref;
      a.target = "_blank";
      a.rel = "noopener noreferrer";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  </script>
  <!-- SCRIPT LOCATION HEAD END -->
</head>
<body class="m-0">
  <div id="root"></div>

  <!-- React and ReactDOM -->
  <!-- Babel -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap"
    rel="stylesheet"
  />

  <style>
    * {
      font-family: "Geist", sans-serif;
    }
    .fade-in {
      opacity: 0;
      animation: fadeIn 0.3s ease-in-out forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
  </style>

  <script type="module">
    // Import do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAuvYjA76NxkoOOVHsgi8xrF7APA3NcP_o",
      authDomain: "freedomquiz-99fac.firebaseapp.com",
      projectId: "freedomquiz-99fac",
      storageBucket: "freedomquiz-99fac.firebasestorage.app",
      messagingSenderId: "651018164441",
      appId: "1",
    };

    // Inicia Firebase
    window.app = initializeApp(firebaseConfig);
    window.firestore = getFirestore(app);
    window.doc = doc;
    window.getDoc = getDoc;
    window.collection = collection;
    window.addDoc = addDoc;
  </script>

  <script type="text/babel">
    // ==========================================
    // A PARTIR DAQUI NÃO DEFINIMOS safeOpenUrl
    // A FUNÇÃO safeOpenUrl ESTÁ NO <head>!
    // ==========================================

    const gatherFormQuestions = () => {
      // get forms values
      document.querySelectorAll('form.user-form').forEach((form) => {
        // get all inputs and textareas from children of this form
        const inputs = form.querySelectorAll('input, textarea')
        inputs.forEach((input) => {
          id_value_pairs.push({
            id: input.id,
            value: input.value,
            type: input.type,
            label: input.id.split('--')[1],
          })
        })
      })

      document.querySelectorAll('.question-item.on').forEach((item) => {
        const id = item.getAttribute('for')
        const title = item.querySelector('.title-question').innerText

        id_value_pairs.push({
          id,
          value: true,
          label: title,
          type: 'question'
        })
      })
      document.querySelectorAll('.question-item.off').forEach((item) => {
        const id = item.getAttribute('for')
        const title = item.querySelector('.title-question').innerText

        id_value_pairs.push({
          id,
          value: false,
          label: title,
          type: 'question'
        })
      })

      // get all weight components
      document.querySelectorAll('.weight').forEach((component) => {
        const weight = component.querySelector('.weight-input').value
        const title = component.querySelector('.weight-label').innerText
        id_value_pairs.push({
          id: component.id,
          value: weight,
          label: title,
          type: 'weight'
        })
      })

      // Remove duplicates by creating a Map with a composite key
      const uniqueMap = new Map();
      id_value_pairs.forEach(item => {
        const key = `${item.id}-${item.type}-${item.label}`;
        uniqueMap.set(key, item);
      });
      
      // Convert back to array
      id_value_pairs = Array.from(uniqueMap.values());
    }

    // Variáveis globais
    window.id_value_pairs = []
    function uuidv4() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function SimpleSpinner({ size = 40 }) {
      const spinnerStyle = {
        width: `${size}px`,
        height: `${size}px`,
        border: `4px solid #f3f3f3`,
        borderTop: `4px solid #3498db`,
        borderRadius: '50%',
        animation: 'spin 1s linear infinite',
      };

      const keyframes = `
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      `;

      return React.createElement(
        'div',
        { style: { display: 'inline-block' } },
        React.createElement('style', null, keyframes),
        React.createElement('div', { style: spinnerStyle })
      );
    }

    const funil_id = '1cab8a18-ddc8-4c37-8688-f016ce64db48'
    const funil_name = 'Quiz 03 - YT - Cloaker'

    // (Código do React e componentes customizados)...
    // ==================================================
    // ... (Idêntico ao que você já tinha)
    // ==================================================

    function collectUserInfo() {
      const userInfo = {
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        language: navigator.language,
        screenResolution: `${window.screen.width}x${window.screen.height}`,
        viewportSize: `${window.innerWidth}x${window.innerHeight}`,
        referrer: document.referrer || "Direct",
        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        colorDepth: window.screen.colorDepth,
        online: navigator.onLine,
        cookiesEnabled: navigator.cookieEnabled,
      };
      return userInfo;
    }

    function App() {
      const [loading, setLoading] = React.useState(true)
      const [funil, setFunil] = React.useState(null)
      const [funilStructure, setFunilStructure] = React.useState(null)

      const parseDate = (date) => {
        try {
          return new Date(date)
        } catch (error) {
          return new Date()
        }
      }

      React.useEffect(() => {
        (async () => {
          try {
            const db = firestore;
            const docRef = doc(db, 'funis-base', funil_id);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
              setFunil(docSnap.data());

              const docRefStructure = doc(db, 'funis-structure', funil_id);
              const docSnapStructure = await getDoc(docRefStructure);
              if (docSnapStructure.exists()) {
                const funilStructure = docSnapStructure.data();
                console.log(funilStructure)
                funilStructure.steps.forEach(step => {
                  step.contents.forEach(component => {
                    if (component.type === 'timer') {
                      component.date = parseDate(component.date)
                    }
                  })
                })
                setFunilStructure(funilStructure);
              }

              // Registra acesso
              const acessosCollection = collection(db, 'acessos')
              const newAcesso = {
                id: localStorage.getItem('uuid'),
                date: new Date(),
                funil_id: funil_id,
                user_info: collectUserInfo(),
              }
              await addDoc(acessosCollection, newAcesso);

              setLoading(false)
            } else {
              alert('Funil não encontrado')
            }
          } catch (error) {
            console.log(error)
            alert("Erro ao carregar o funil, tente outro link")
          }
        })().then(() => {
          setTimeout(() => {
            lucide.createIcons();
            var splide = new Splide('.splide');
            splide.mount();
          }, 200)
        })
      }, [])

      return (
        <div className="w-full bg-neutral-100 h-screen flex flex-col justify-center items-center">
          {
            loading
              ? <SimpleSpinner />
              : <FunilContainer funil={funil} funilStructure={funilStructure} />
          }
        </div>
      );
    }

    // Gera um uuid se não existir
    if (!localStorage.getItem('uuid')) {
      localStorage.setItem('uuid', uuidv4());
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);

    document.addEventListener('DOMContentLoaded', function() {
      var splide = new Splide('.splide');
      splide.mount();
    });
  </script>

  <script src="https://unpkg.com/lucide@latest"></script>
  <script defer>
    lucide.createIcons();
  </script>

  <!-- SCRIPT LOCATION FOOTER START -->
  <!-- Se precisar de algo adicional, coloque aqui -->
  <!-- SCRIPT LOCATION FOOTER END -->
</body>
</html>
